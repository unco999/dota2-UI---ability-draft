/**
 * OMG的全英雄池
 * 
 * 不想要的英雄注释即可
 */
export const OMGAllHeros = [
    'npc_dota_hero_ancient_apparition',
    'npc_dota_hero_antimage',
    'npc_dota_hero_axe',
    'npc_dota_hero_bane',
    'npc_dota_hero_beastmaster',
    'npc_dota_hero_bloodseeker',
    'npc_dota_hero_chen',
    'npc_dota_hero_crystal_maiden',
    'npc_dota_hero_dark_seer',
    'npc_dota_hero_dazzle',
    'npc_dota_hero_dragon_knight',
    'npc_dota_hero_doom_bringer',
    'npc_dota_hero_drow_ranger',
    'npc_dota_hero_earthshaker',
    'npc_dota_hero_enchantress',
    'npc_dota_hero_enigma',
    'npc_dota_hero_faceless_void',
    'npc_dota_hero_furion',
    'npc_dota_hero_juggernaut',
    'npc_dota_hero_kunkka',
    'npc_dota_hero_leshrac',
    'npc_dota_hero_lich',
    'npc_dota_hero_life_stealer',
    'npc_dota_hero_lina',
    'npc_dota_hero_lion',
    'npc_dota_hero_mirana',
    //'npc_dota_hero_morphling',
    'npc_dota_hero_necrolyte',
    'npc_dota_hero_nevermore',
    //'npc_dota_hero_night_stalker',
    'npc_dota_hero_omniknight',
    'npc_dota_hero_puck',
    'npc_dota_hero_pudge',
    'npc_dota_hero_pugna',
    'npc_dota_hero_rattletrap',
    'npc_dota_hero_razor',
    'npc_dota_hero_riki',
    'npc_dota_hero_sand_king',
    'npc_dota_hero_shadow_shaman',
    'npc_dota_hero_slardar',
    'npc_dota_hero_sniper',
    'npc_dota_hero_spectre',
    'npc_dota_hero_storm_spirit',
    'npc_dota_hero_sven',
    'npc_dota_hero_tidehunter',
    'npc_dota_hero_tinker',
    'npc_dota_hero_tiny',
    'npc_dota_hero_vengefulspirit',
    'npc_dota_hero_venomancer',
    'npc_dota_hero_viper',
    'npc_dota_hero_weaver',
    'npc_dota_hero_windrunner',
    'npc_dota_hero_witch_doctor',
    'npc_dota_hero_zuus',
    'npc_dota_hero_broodmother',
    // 'npc_dota_hero_skeleton_king',
    'npc_dota_hero_queenofpain',
    'npc_dota_hero_huskar',
    //'npc_dota_hero_jakiro',
    //'npc_dota_hero_batrider',
    'npc_dota_hero_warlock',
    'npc_dota_hero_alchemist',
    'npc_dota_hero_death_prophet',
    'npc_dota_hero_ursa',
    'npc_dota_hero_bounty_hunter',
    'npc_dota_hero_silencer',
    'npc_dota_hero_spirit_breaker',
    'npc_dota_hero_invoker',
    'npc_dota_hero_clinkz',
    'npc_dota_hero_obsidian_destroyer',
    'npc_dota_hero_shadow_demon',
    'npc_dota_hero_lycan',
    //'npc_dota_hero_lone_druid',
    'npc_dota_hero_brewmaster',
    'npc_dota_hero_phantom_lancer',
    'npc_dota_hero_treant',
    'npc_dota_hero_ogre_magi',
    'npc_dota_hero_chaos_knight',
    'npc_dota_hero_phantom_assassin',
    'npc_dota_hero_gyrocopter',
    //'npc_dota_hero_rubick',
    'npc_dota_hero_luna',
    //'npc_dota_hero_wisp',
    'npc_dota_hero_disruptor',
    //'npc_dota_hero_undying',
    'npc_dota_hero_templar_assassin',
    //'npc_dota_hero_naga_siren',
    'npc_dota_hero_nyx_assassin',
    'npc_dota_hero_keeper_of_the_light',
    'npc_dota_hero_visage',
    //'npc_dota_hero_meepo',
    'npc_dota_hero_magnataur',
    'npc_dota_hero_centaur',
    //'npc_dota_hero_slark',
    'npc_dota_hero_shredder',
    'npc_dota_hero_medusa',
    'npc_dota_hero_troll_warlord',
    'npc_dota_hero_tusk',
    'npc_dota_hero_bristleback',
    'npc_dota_hero_skywrath_mage',
    'npc_dota_hero_elder_titan',
    'npc_dota_hero_abaddon',
    'npc_dota_hero_earth_spirit',
    'npc_dota_hero_ember_spirit',
    'npc_dota_hero_legion_commander',
    'npc_dota_hero_phoenix',
    'npc_dota_hero_terrorblade',
    'npc_dota_hero_techies',
    'npc_dota_hero_oracle',
    'npc_dota_hero_winter_wyvern',
    'npc_dota_hero_arc_warden',
    'npc_dota_hero_abyssal_underlord',
    'npc_dota_hero_monkey_king',
    'npc_dota_hero_dark_willow',
    'npc_dota_hero_pangolier',
    'npc_dota_hero_grimstroke',
    'npc_dota_hero_mars',
    'npc_dota_hero_snapfire',
    'npc_dota_hero_void_spirit',
    'npc_dota_hero_muerta',
    'npc_dota_hero_marci',

]

export const OmgAllAbility = [
    'abaddon_aphotic_shield',
    'abaddon_death_coil',
    'abaddon_frostmourne',
    'abyssal_underlord_atrophy_aura',
    'abyssal_underlord_firestorm',
    'abyssal_underlord_pit_of_malice',
    'alchemist_acid_spray',
    'alchemist_corrosive_weaponry',
    'alchemist_goblins_greed',
    //'alchemist_unstable_concoction',
    'ancient_apparition_chilling_touch',
    'ancient_apparition_cold_feet',
    'ancient_apparition_ice_vortex',
    'antimage_blink',
    'antimage_counterspell',
    'antimage_mana_break',
    'arc_warden_flux',
    'arc_warden_magnetic_field',
    'arc_warden_spark_wraith',
    'axe_battle_hunger',
    'axe_berserkers_call',
    'axe_counter_helix',
    'bane_brain_sap',
    'bane_enfeeble',
    //'bane_nightmare',
    'batrider_firefly',
    'batrider_flamebreak',
    'batrider_sticky_napalm',
    //'beastmaster_call_of_the_wild_hawk',
    'beastmaster_inner_beast',
    'beastmaster_wild_axes',
    'bloodseeker_blood_bath',
    'bloodseeker_bloodrage',
    'bloodseeker_thirst',
    'bounty_hunter_jinada',
    'bounty_hunter_shuriken_toss',
    'bounty_hunter_wind_walk',
    'brewmaster_cinder_brew',
    'brewmaster_drunken_brawler',
    'brewmaster_thunder_clap',
    'bristleback_bristleback',
    'bristleback_quill_spray',
    'bristleback_viscous_nasal_goo',
    'broodmother_insatiable_hunger',
    'broodmother_silken_bola',
    'broodmother_spin_web',
    'centaur_double_edge',
    'centaur_hoof_stomp',
    'centaur_return',
    'chaos_knight_chaos_bolt',
    'chaos_knight_chaos_strike',
    'chaos_knight_reality_rift',
    'chen_divine_favor',
    'chen_holy_persuasion',
    'chen_penitence',
    'clinkz_death_pact',
    'clinkz_strafe',
    'clinkz_tar_bomb',
    'crystal_maiden_brilliance_aura',
    'crystal_maiden_crystal_nova',
    'crystal_maiden_frostbite',
    'dark_seer_ion_shell',
    'dark_seer_surge',
    'dark_seer_vacuum',
    'dark_willow_bramble_maze',
    'dark_willow_cursed_crown',
    'dark_willow_shadow_realm',
    //'dawnbreaker_celestial_hammer',
    'dawnbreaker_fire_wreath',
    'dawnbreaker_luminosity',
    'dazzle_poison_touch',
    'dazzle_shadow_wave',
    'dazzle_shallow_grave',
    'death_prophet_carrion_swarm',
    'death_prophet_silence',
    'death_prophet_spirit_siphon',
    'disruptor_glimpse',
    'disruptor_kinetic_field',
    'disruptor_thunder_strike',
    'doom_bringer_devour',
    'doom_bringer_infernal_blade',
    'doom_bringer_scorched_earth',
    'dragon_knight_breathe_fire',
    'dragon_knight_dragon_blood',
    'dragon_knight_dragon_tail',
    'drow_ranger_frost_arrows',
    'drow_ranger_multishot',
    'drow_ranger_wave_of_silence',
    //'earth_spirit_boulder_smash',
    //'earth_spirit_geomagnetic_grip',
    //'earth_spirit_rolling_boulder',
    'earthshaker_aftershock',
    'earthshaker_enchant_totem',
    'earthshaker_fissure',
    //'elder_titan_ancestral_spirit',
    'elder_titan_echo_stomp',
    'elder_titan_natural_order',
    'ember_spirit_flame_guard',
    'ember_spirit_searing_chains',
    'ember_spirit_sleight_of_fist',
    'enchantress_enchant',
    'enchantress_impetus',
    'enchantress_natures_attendants',
    'enigma_demonic_conversion',
    'enigma_malefice',
    'enigma_midnight_pulse',
    'faceless_void_time_dilation',
    'faceless_void_time_lock',
    'faceless_void_time_walk',
    'furion_force_of_nature',
    'furion_sprout',
    'furion_teleportation',
    'grimstroke_dark_artistry',
    'grimstroke_ink_creature',
    'grimstroke_spirit_walk',
    'gyrocopter_flak_cannon',
    'gyrocopter_homing_missile',
    'gyrocopter_rocket_barrage',
    'hoodwink_acorn_shot',
    'hoodwink_bushwhack',
    'hoodwink_scurry',
    'huskar_berserkers_blood',
    'huskar_burning_spear',
    'huskar_inner_fire',
    //'invoker_alacrity_ad',
    //'invoker_chaos_meteor_ad',
    //'invoker_cold_snap_ad',
    //'invoker_deafening_blast_ad',
    //'invoker_emp_ad',
    //'invoker_forge_spirit_ad',
    //'invoker_ghost_walk_ad',
    //'invoker_ice_wall_ad',
    //'invoker_sun_strike_ad',
    //'invoker_tornado_ad',
    'jakiro_dual_breath',
    'jakiro_ice_path',
    'jakiro_liquid_fire',
    'juggernaut_blade_dance',
    'juggernaut_blade_fury',
    'juggernaut_healing_ward',
    'keeper_of_the_light_blinding_light',
    'keeper_of_the_light_chakra_magic',
    //'keeper_of_the_light_illuminate',
    'kunkka_tidebringer',
    'kunkka_torrent',
    //'kunkka_x_marks_the_spot',
    'legion_commander_moment_of_courage',
    'legion_commander_overwhelming_odds',
    'legion_commander_press_the_attack',
    'leshrac_diabolic_edict',
    'leshrac_lightning_storm',
    'leshrac_split_earth',
    'lich_frost_nova',
    'lich_frost_shield',
    'lich_sinister_gaze',
    'life_stealer_feast',
    'life_stealer_ghoul_frenzy',
    'life_stealer_rage',
    'lina_dragon_slave',
    'lina_fiery_soul',
    'lina_light_strike_array',
    'lion_impale',
    'lion_mana_drain',
    'lion_voodoo',
    //'lone_druid_savage_roar',
    'lone_druid_spirit_bear',
    //'lone_druid_spirit_link',
    'luna_lucent_beam',
    'luna_lunar_blessing',
    'luna_moon_glaive',
    'lycan_feral_impulse',
    'lycan_howl',
    'lycan_summon_wolves',
    'magnataur_empower',
    'magnataur_shockwave',
    'magnataur_skewer',
    'marci_companion_run',
    'marci_grapple',
    'marci_guardian',
    //'mars_bulwark',
    'mars_gods_rebuke',
    'mars_spear',
    'medusa_mana_shield',
    'medusa_mystic_snake',
    'medusa_split_shot',
    //'meepo_earthbind',
    //'meepo_poof',
    //'meepo_ransack',
    'mirana_arrow',
    'mirana_leap',
    'mirana_starfall',
    'monkey_king_boundless_strike',
    'monkey_king_jingu_mastery',
    //'monkey_king_tree_dance',
    //'morphling_adaptive_strike_agi',
    //'morphling_adaptive_strike_str',
    //'morphling_morph_agi',
    'morphling_waveform',
    'muerta_dead_shot',
    'muerta_gunslinger',
    'muerta_the_calling',
    'naga_siren_ensnare',
    'naga_siren_mirror_image',
    'naga_siren_rip_tide',
    'necrolyte_death_pulse',
    'necrolyte_heartstopper_aura',
    'necrolyte_ghost_shroud',
    'nevermore_dark_lord',
    'nevermore_necromastery',
    //'nevermore_shadowraze2',
    //'night_stalker_crippling_fear',
    //'night_stalker_hunter_in_the_night',
    //'night_stalker_void',
    'nyx_assassin_impale',
    'nyx_assassin_jolt',
    'nyx_assassin_spiked_carapace',
    'obsidian_destroyer_arcane_orb',
    'obsidian_destroyer_astral_imprisonment',
    'obsidian_destroyer_equilibrium',
    'ogre_magi_bloodlust',
    'ogre_magi_fireblast',
    'ogre_magi_ignite',
    'omniknight_hammer_of_purity',
    'omniknight_martyr',
    'omniknight_purification',
    'oracle_fates_edict',
    'oracle_fortunes_end',
    'oracle_purifying_flames',
    'pangolier_lucky_shot',
    'pangolier_shield_crash',
    'pangolier_swashbuckle',
    'phantom_assassin_blur',
    'phantom_assassin_phantom_strike',
    'phantom_assassin_stifling_dagger',
    'phantom_lancer_doppelwalk',
    'phantom_lancer_phantom_edge',
    'phantom_lancer_spirit_lance',
    //'phoenix_fire_spirits',
    //'phoenix_icarus_dive',
    //'phoenix_sun_ray',
    'primal_beast_onslaught',
    'primal_beast_trample',
    'primal_beast_uproar',
    //'puck_illusory_orb',
    'puck_phase_shift',
    'puck_waning_rift',
    'pudge_flesh_heap',
    'pudge_meat_hook',
    'pudge_rot',
    'pugna_decrepify',
    'pugna_nether_blast',
    'pugna_nether_ward',
    'queenofpain_blink',
    'queenofpain_scream_of_pain',
    'queenofpain_shadow_strike',
    'rattletrap_battery_assault',
    'rattletrap_power_cogs',
    'rattletrap_rocket_flare',
    'razor_plasma_field',
    'razor_static_link',
    'razor_unstable_current',
    'riki_blink_strike',
    'riki_smoke_screen',
    'riki_tricks_of_the_trade',
    'rubick_arcane_supremacy',
    'rubick_fade_bolt',
    //'rubick_telekinesis',
    'sandking_burrowstrike',
    'sandking_sand_storm',
    'shadow_demon_disruption',
    'shadow_demon_disseminate',
    //'shadow_demon_shadow_poison',
    'shadow_shaman_ether_shock',
    'shadow_shaman_shackles',
    'shadow_shaman_voodoo',
    'shredder_reactive_armor',
    'shredder_timber_chain',
    'shredder_whirling_death',
    'silencer_curse_of_the_silent',
    'silencer_glaives_of_wisdom',
    'silencer_last_word',
    'skeleton_king_hellfire_blast',
    'skeleton_king_mortal_strike',
    'skywrath_mage_ancient_seal',
    'skywrath_mage_arcane_bolt',
    'skywrath_mage_concussive_shot',
    'slardar_bash',
    'slardar_slithereen_crush',
    'slardar_sprint',
    'slark_dark_pact',
    'slark_essence_shift',
    'slark_pounce',
    'snapfire_firesnap_cookie',
    'snapfire_lil_shredder',
    'snapfire_scatterblast',
    'sniper_headshot',
    'sniper_shrapnel',
    'sniper_take_aim',
    'spectre_desolate',
    'spectre_dispersion',
    'spectre_spectral_dagger',
    'spirit_breaker_bulldoze',
    'spirit_breaker_charge_of_darkness',
    'spirit_breaker_greater_bash',
    'storm_spirit_electric_vortex',
    'storm_spirit_overload',
    'storm_spirit_static_remnant',
    'sven_great_cleave',
    'sven_storm_bolt',
    'sven_warcry',
    'techies_reactive_tazer',
    'techies_sticky_bomb',
    'techies_suicide',
    'templar_assassin_meld',
    'templar_assassin_psi_blades',
    'templar_assassin_refraction',
    'terrorblade_conjure_image',
    'terrorblade_metamorphosis',
    'terrorblade_reflection',
    'tidehunter_anchor_smash',
    'tidehunter_gush',
    'tidehunter_kraken_shell',
    'tinker_defense_matrix',
    'tinker_heat_seeking_missile',
    'tinker_laser',
    'tiny_avalanche',
    'tiny_toss',
    //'tiny_tree_grab',
    'treant_leech_seed',
    'treant_living_armor',
    'treant_natures_grasp',
    'troll_warlord_fervor',
    //'troll_warlord_whirling_axes_melee',
    //'troll_warlord_whirling_axes_ranged',
    'tusk_ice_shards',
    'tusk_snowball',
    'tusk_tag_team',
    'undying_decay',
    'undying_soul_rip',
    'undying_tombstone',
    'ursa_earthshock',
    'ursa_fury_swipes',
    'ursa_overpower',
    'vengefulspirit_command_aura',
    'vengefulspirit_magic_missile',
    'vengefulspirit_wave_of_terror',
    'venomancer_plague_ward',
    'venomancer_poison_sting',
    'venomancer_venomous_gale',
    'viper_corrosive_skin',
    'viper_nethertoxin',
    'viper_poison_attack',
    'visage_grave_chill',
    'visage_gravekeepers_cloak',
    'visage_soul_assumption',
    'void_spirit_aether_remnant',
    'void_spirit_dissimilate',
    'void_spirit_resonant_pulse',
    'warlock_fatal_bonds',
    'warlock_shadow_word',
    'warlock_upheaval',
    'weaver_geminate_attack',
    'weaver_shukuchi',
    'weaver_the_swarm',
    'windrunner_powershot',
    'windrunner_shackleshot',
    'windrunner_windrun',
    'winter_wyvern_arctic_burn',
    'winter_wyvern_cold_embrace',
    'winter_wyvern_splinter_blast',
    'wisp_overcharge',
    //'wisp_spirits',
    'wisp_tether',
    'witch_doctor_maledict',
    'witch_doctor_paralyzing_cask',
    'witch_doctor_voodoo_restoration',
    'zuus_arc_lightning',
    'zuus_heavenly_jump',
    'zuus_lightning_bolt',
]


export function GetAllPlayers(): PlayerID[] {
    if (PlayerResource == undefined) return
    const players: PlayerID[] = []
    for (let i = 0; i < PlayerResource.GetPlayerCount(); i++) {
        if (PlayerResource.IsValidPlayer(i)) players.push(i)
    }
    return players
}

const select_sequence = [
    DotaTeam.CUSTOM_1,
    DotaTeam.CUSTOM_2,
    DotaTeam.CUSTOM_3,
    DotaTeam.CUSTOM_4
]


export class AbilityDraftManager{
    client_data:AbilityDraftNettableData = {global:{}} 
    ability_pool:AbilityDraftAbilityPool = {global:[]}
    state:AbilityDraftState = {global:{is_ban_state:1,is_over:0} as any}
    curr_select_sequence = table.shuffle(select_sequence)
    curr_player_select_over:boolean = false
    timers:string[] = []

    curr_player_select_ability_sequence:PlayerID[] = []
    curr_ban_sequence:PlayerID[] = []
    curr_player_select_ability_sequence_index:number = 0
    curr_ban_sequence_index:number = 0
    
    constructor(){
       this.Event()
    } 

    initTeamDATA(){
        this.curr_select_sequence = this.curr_select_sequence.filter(teamid=> !(PlayerResource.GetNthPlayerIDOnTeam(teamid,1) == -1 && PlayerResource.GetNthPlayerIDOnTeam(teamid,2) == -1))
        this.curr_player_select_ability_sequence = this.curr_select_sequence.map(teamid=> [PlayerResource.GetNthPlayerIDOnTeam(teamid,1),PlayerResource.GetNthPlayerIDOnTeam(teamid,2)]).flat().filter(pid=>pid!=-1)
        this.curr_ban_sequence = this.curr_player_select_ability_sequence.reverse()
    }

    stateRoundChange(){
        if(this.state.global.is_ban_state == 1){
            this.curr_ban_sequence_index++   
            if(this.curr_ban_sequence_index > this.curr_ban_sequence.length - 1){
                this.curr_ban_sequence_index = 0   
            }
        }else{
            this.curr_player_select_ability_sequence_index++
            if(this.curr_player_select_ability_sequence_index > this.curr_player_select_ability_sequence.length - 1){
                this.curr_player_select_ability_sequence_index = 0   
            }
        }
        this.state.global.curr_time_left = 6
        this.curr_player_select_over = false
    }

    stateEnd(){
        this.timers.forEach(id=>Timers.RemoveTimer(id))
        this.state.global.is_over = 1;
        this.abilityDraftStateClient()
        Timers.CreateTimer(5,()=>{GetAllPlayers()?.forEach(PlayerID=>{
            CustomUI.DynamicHud_Destroy(PlayerID, 'ability_draft')
        })},this)
    }

    stateStart(){
        this.initTeamDATA()
        this.state.global.curr_time_left = 6
        const t1 = Timers.CreateTimer(5,()=>{
            if(this.state.global.is_ban_state == 0) return 1
            this.state.global.curr_select_ability_player_id = this.curr_player_select_ability_sequence[this.curr_player_select_ability_sequence_index]
            print("当前ban技能的玩家 ",this.state.global.curr_select_ability_player_id)

            if(this.ability_pool.global.filter(elm=>elm.ban == 1).length == GetAllPlayers().length){
                print("状态结束 ban技能等于8")
                this.state.global.is_ban_state = 0
                this.abilityDraftStateClient()
                return 
            }

            if(this.state.global.curr_time_left == 0 && !this.curr_player_select_over){
                const pick = Object.entries(this.client_data.global).find(([pid,elm])=>{
                    return this.state.global.curr_select_ability_player_id == Number(pid)
                })
                const pick_ability = table.shuffle(this.ability_pool.global).find(elm=>elm.is_select == 0 && elm.ban == 0)
                this.client_data.global[pick[1].PlayerID].curr_ban_ability.push(pick_ability.ability_name)
                this.ability_pool.global.find(elm=>elm.ability_name == pick_ability.ability_name).ban = 1
                this.Client()
                this.abilityPoolClient()
                this.stateRoundChange()
            }

            if(this.curr_player_select_over){
                this.stateRoundChange()
            }
            this.state.global.curr_time_left--;
            this.abilityDraftStateClient()
            return 1
        })
        const t2 = Timers.CreateTimer(5,()=>{
            if(this.state.global.is_ban_state == 1) return 1
            this.state.global.curr_select_ability_player_id = this.curr_ban_sequence[this.curr_ban_sequence_index]
            print("当前选择技能的玩家 ",this.state.global.curr_select_ability_player_id)


            if(Object.values(this.client_data.global).every(elm=>elm.curr_select_ability.length == 3)){
                this.stateEnd()
                return 
            }
            //时间到了他没选技能
            if(this.state.global.curr_time_left == 0 && !this.curr_player_select_over){
                const pick = Object.entries(this.client_data.global).find(([pid,elm])=>{
                    return this.state.global.curr_select_ability_player_id == Number(pid)
                })
                const pick_ability = table.shuffle(this.ability_pool.global).find(elm=>elm.is_select == 0 && elm.ban == 0)
                this.client_data.global[pick[1].PlayerID].curr_select_ability.push(pick_ability.ability_name)
                this.ability_pool.global.find(elm=>elm.ability_name == pick_ability.ability_name).is_select = 1
                this.Client()
                this.abilityPoolClient()
                this.stateRoundChange()
            }
            //他选择了技能
            if(this.curr_player_select_over){
                this.stateRoundChange()
            }
            this.state.global.curr_time_left--;
            this.abilityDraftStateClient()
            return 1
        },this)
        this.timers.push(t1,t2)
    }

    Event(){
        ListenToGameEvent("game_rules_state_change",()=>{
            if(GameRules.State_Get() == GameState.STRATEGY_TIME){
                this.SCENARIO_SETUP()
                this.stateStart()
            }
            if(GameRules.State_Get() == GameState.HERO_SELECTION){
                this.SLECLT_HERO()
            }
        },this)
        CustomGameEventManager.RegisterListener("c2s_select_ability",(_,event)=>{
            if(this.client_data.global[event.PlayerID] == null){
                this.client_data.global[event.PlayerID] = {} 
            }
            if(this.curr_player_select_over){
                print("你已经选了")
                return
            }
            if(this.state.global.curr_select_ability_player_id != event.PlayerID || this.state.global.is_ban_state == 1){
                print("当前不能选择技能")
                return;
            }
            if(this.client_data.global[event.PlayerID].curr_select_ability.length == 3){
                print("当前选择无效 技能超过了3个")
                return
            }
            const ability_data = this.ability_pool.global.find(e=>e.ability_name == event.try_select_ability);
            if(ability_data == null || ability_data.is_select == 1 || ability_data.ban == 1 ){
                print("当前选择无效")
                return
            }
            ability_data.is_select = 1
            this.client_data.global[event.PlayerID].curr_select_ability.push(event.try_select_ability)
            if(this.state.global.curr_select_ability_player_id == event.PlayerID){
                this.curr_player_select_over = true;
            }
            this.Client()
            this.abilityPoolClient()
        })
        CustomGameEventManager.RegisterListener("c2s_ban_ability",(_,event)=>{
            DeepPrintTable(event)
            const ability_data = this.ability_pool.global.find(e=>e.ability_name == event.try_ban_ability);
            if(this.curr_player_select_over){
                print("你已经选了")
                return
            }
            if(this.state.global.curr_select_ability_player_id != event.PlayerID || this.state.global.is_ban_state == 0){
                print("当前不是你ban技能")
                return;
            }
            if(ability_data == null || ability_data.is_select == 1 || ability_data.ban == 1 ){
                print("当前选择无效")
                return
            }
            this.curr_player_select_over = true
            ability_data.ban = 1
            ability_data.ban_player_id = event.PlayerID
            this.Client()
            this.abilityPoolClient()
        })
    }

    initDatedata(){
        GetAllPlayers()?.forEach(PlayerID=>{
            const select_hero = PlayerResource.GetSelectedHeroName(PlayerID)
            if(this.client_data.global[PlayerID] == null){
                this.client_data.global[PlayerID] = {}   
            }
            this.client_data.global[PlayerID].curr_ban_ability = []
            this.client_data.global[PlayerID].curr_select_ability = []
            this.client_data.global[PlayerID].curr_select_hero = select_hero
            this.client_data.global[PlayerID].team = PlayerResource.GetPlayer(PlayerID).GetTeamNumber()
            this.client_data.global[PlayerID].PlayerID = PlayerID
        })
        const omg_ability_pool = table.shuffle(OmgAllAbility)
        for (let i = 0 ; i < 36 ; i++){
            this.ability_pool.global.push({
                ability_name:omg_ability_pool[i],
                ban:0,
                is_select:0,
                select_player_id:-1,
                ban_player_id:-1
            })
        }
        this.Client()
        this.abilityPoolClient()
    }



    abilityPoolClient(){
        CustomNetTables.SetTableValue("ability_pool","global",this.ability_pool.global)
    }

    Client(){
        CustomNetTables.SetTableValue("ability_draft","global",this.client_data.global)
    }

    abilityDraftStateClient(){
        CustomNetTables.SetTableValue("ability_draft_state","global",this.state.global)
    }

    SCENARIO_SETUP(){
        this.initDatedata()
        GetAllPlayers()?.forEach(PlayerID=>{
            CustomUI.DynamicHud_Create(PlayerID, 'ability_draft', 'file://{resources}/layout/custom_game/ability_draft.xml', {})
        })
    }
 
    SLECLT_HERO(){
        GetAllPlayers()?.forEach(PlayerID=>{
            PlayerResource.GetPlayer(PlayerID).SetSelectedHero(OMGAllHeros[RandomInt(0,OMGAllHeros.length)])
        })
    }
}